(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{245:function(s,n,t){"use strict";t.r(n);var e=t(2),a=Object(e.a)({},function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概念","aria-hidden":"true"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),t("p",[s._v("Zuul的主要功能是路由转发和过滤器。路由功能是微服务的一部分，比如/api/user转发到到用户服务，/api/address转发到到地址服务。zuul默认和Ribbon结合实现了负载均衡的功能。同时本篇还介绍zuul和文件上传微服务功能的结合。")]),s._v(" "),t("p",[s._v("本篇涉及项目的结构为一个Eureka Server用于其他微服务注册，client1和client2是两个不同的微服务提供者，web是zuul可配置转发到不同的client上。同时client1还会在最后模拟文件上传功能。")]),s._v(" "),t("h2",{attrs:{id:"eureka-server"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#eureka-server","aria-hidden":"true"}},[s._v("#")]),s._v(" Eureka Server")]),s._v(" "),t("p",[s._v("新建一个普通的Eureka Server，分别配置application.yml、pom.xml和添加注解@EnableEurekaServer")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>\n\t\t</dependency>\nserver:\n  port: 9070\neureka:\n  client:\n    register-with-eureka: false\n    fetch-registry: false\n    service-url:\n      defaultZone: http://localhost:9070/eureka/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("以上步骤完成后，直接启动即可，然后浏览器地址栏输入http://localhost:9070/eureka 查看界面。")]),s._v(" "),t("h2",{attrs:{id:"client"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#client","aria-hidden":"true"}},[s._v("#")]),s._v(" Client")]),s._v(" "),t("p",[s._v("新建两个Eureka Client，分别配置application.yml、pom.xml和添加注解@EnableDiscoveryClient，然后提供对外调用接口的Java类。除了不同的返回值用于区分，端口号设置成不一致外，其他的完全一样。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('server:\n  port: 9071\nspring:\n  application:\n    name: zuul-client1\neureka: \n  client:\n    service-url:\n      defaultZone: http://localhost:9070/eureka/\n  instance:\n    prefer-ip-address: true\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>\n\t\t</dependency>\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.PathVariable;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class TestController {\n\n\t@GetMapping("/{id}")\n\tpublic String getMessage(@PathVariable Long id) {\n\t\treturn "the request1 id is " + id;\n\t}\n\t\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br")])]),t("h2",{attrs:{id:"web"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#web","aria-hidden":"true"}},[s._v("#")]),s._v(" Web")]),s._v(" "),t("p",[s._v("接下来新建一个整合了Zuul的项目，pom文件依赖为")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-netflix-zuul</artifactId>\n\t\t</dependency>\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("application.yml的配置中，可通过zuul.routes.名称.path和zuul.routes.名称.serviceId指定访问微服务对应的url路径：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("eureka:\n  client:\n    serviceUrl:\n      defaultZone: http://localhost:9070/eureka/\nserver:\n  port: 9073\nspring:\n  application:\n    name: zuul-web\nzuul: \n  routes:\n    api-1:\n      path: /api-client1/**\n      serviceId: zuul-client1\n    api-2:\n      path: /api-client2/**\n      serviceId: zuul-client2\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("通过上面的配置，可实现的效果为访问api-client1会调用zuul-client1中的对应方法。")]),s._v(" "),t("p",[s._v("项目启动类添加注解@EnableDiscoveryClient 和 @EnableZuulProxy。")]),s._v(" "),t("p",[s._v("分别启动server、client1、client2、web，访问http://localhost:9073/api-client1/1234 和 http://localhost:9073/api-client2/2345 可实现对两个不同微服务的访问测试。")]),s._v(" "),t("h2",{attrs:{id:"过滤器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#过滤器","aria-hidden":"true"}},[s._v("#")]),s._v(" 过滤器")]),s._v(" "),t("p",[s._v("本节实现一个最简单的过滤器，判断请求中是否有username字段参数，如果有的话判断如果是fymod就返回特定值。")]),s._v(" "),t("p",[s._v("新建一个Controller，其中filterType方法指定的是何时调用，filterOrder是有多个过滤器的时候如何排序，shouldFilter可指定何时过滤，run方法就是具体逻辑了。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import javax.servlet.http.HttpServletRequest;\n\nimport org.springframework.stereotype.Component;\n\nimport com.netflix.zuul.ZuulFilter;\nimport com.netflix.zuul.context.RequestContext;\n\n@Component\npublic class MyFilter extends ZuulFilter {\n\n\t@Override\n\tpublic String filterType() {\n//\t\tpre：路由之前\n//\t\trouting：路由之时\n//\t\tpost： 路由之后\n//\t\terror：发送错误调用\n\t\treturn "pre";\n\t}\n\n\t/**\n\t * 过滤的顺序\n\t */\n\t@Override\n\tpublic int filterOrder() {\n\t\treturn 0;\n\t}\n\n\t/**\n\t * 这里可以写逻辑判断，是否要过滤，true为永远过滤。\n\t */\n\t@Override\n\tpublic boolean shouldFilter() {\n\t\treturn true;\n\t}\n\n\t/**\n\t * 过滤器的具体逻辑\n\t */\n\t@Override\n\tpublic Object run() {\n\t\tRequestContext ctx = RequestContext.getCurrentContext();\n\t\tHttpServletRequest request = ctx.getRequest();\n\t\tSystem.out.println(request.getMethod() + "--" + request.getRequestURL().toString());\n\t\tObject username = request.getParameter("username");\n\t\tif (username != null && "fymod".equals(username.toString())) {\n\t\t\tctx.setSendZuulResponse(false);\n\t\t\ttry {\n\t\t\t\tctx.getResponse().setContentType("text/html;charset=utf-8");\n\t\t\t\tctx.getResponse().getWriter().write("监控到用户名是fymod");\n\t\t\t} catch (Exception e) {\n\t\t\t\te.printStackTrace();\n\t\t\t}\n\t\t\treturn null;\n\t\t}\n\t\treturn null;\n\t}\n\t\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br")])]),t("p",[s._v("访问http://localhost:9073/api-client2/1234?username=fymod ，会发现返回过滤器中配置的数据。去掉username或者换成其他参数，就会正常走到对应的微服务中。")]),s._v(" "),t("h2",{attrs:{id:"文件上传"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#文件上传","aria-hidden":"true"}},[s._v("#")]),s._v(" 文件上传")]),s._v(" "),t("p",[s._v("文件上传功能对应的官方文档地址可点击"),t("a",{attrs:{href:"https://cloud.spring.io/spring-cloud-static/spring-cloud-netflix/2.0.1.RELEASE/single/spring-cloud-netflix.html#_uploading_files_through_zuul",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("p",[s._v("先实现代码逻辑，在client1中controller类里面写上如下代码")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('\t@PostMapping(value="/upload")\n\tpublic String handleFileUpload(@RequestParam(value="file", required=true) MultipartFile file) throws IOException {\n\t\tbyte[] bytes = file.getBytes();\n\t\tFile fileToSave = new File(file.getOriginalFilename());\n\t\tFileCopyUtils.copy(bytes, fileToSave);\n\t\treturn fileToSave.getAbsolutePath();\n\t}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("此时已经可以实现调用微服务实现文件上传功能了，但是要通过zuul，目前只能实现小文件上传，对于较大文件和特大文件会抛出异常，所以需要在client1的application.yml文件中添加配置项spring.servlet.multipart.max-file-size(默认1M)和spring.servlet.multipart.max-request-size(默认10M)。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("server:\n  port: 9071\nspring:\n  application:\n    name: zuul-client1\n  servlet:\n    multipart:\n      max-file-size: 2000Mb\n      max-request-size: 2500Mb\neureka: \n  client:\n    service-url:\n      defaultZone: http://localhost:9070/eureka/\n  instance:\n    prefer-ip-address: true\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("接下来的问题是zuul调用client1中文件上传方法的时候，文件较大会报错，地址中需要加上前缀/zuul，另外如果文件很大，和client1连接也会超时，所以需要在zuul的application.yml中添加连接超时的配置，就和官方文档给出的代码一样：")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds: 60000\nribbon:\n  ConnectTimeout: 3000\n  ReadTimeout: 60000\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("完成以上步骤后，使用终端实现POST调用，会返回上传文件的完整路径。注意地址是localhost:9073/zuul/api-client1/upload，而不是localhost:9073/api-client1/upload。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('curl -v -H "Transfer-Encoding:chunked" -F "file=@大文件的路径" localhost:9073/zuul/api-client1/upload\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])])])},[],!1,null,null,null);n.default=a.exports}}]);