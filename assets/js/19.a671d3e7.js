(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{242:function(s,n,t){"use strict";t.r(n);var a=t(2),e=Object(a.a)({},function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#概念","aria-hidden":"true"}},[s._v("#")]),s._v(" 概念")]),s._v(" "),t("p",[s._v("微服务架构是通过业务来划分服务的，对外暴露的接口，可能需要很多个服务协同才能完成一个接口功能，如果链路上任何一个服务出现问题，都会形成导致接口调用失败。此时查找出现问题的微服务是很困难的。Spring  Cloud Sleuth主要功能就是在分布式系统中提供追踪解决方案，并且兼容支持了zipkin。\n对于zipkin、pinpoint以及skywalking如何选型，可以移步"),t("a",{attrs:{href:"https://www.cnblogs.com/softidea/p/7612570.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),t("OutboundLink")],1),s._v("查看。")]),s._v(" "),t("p",[s._v("从最简单的开始着手，实现client2调用client1中的微服务接口，然后在zipkin服务端查看。")]),s._v(" "),t("h2",{attrs:{id:"zipkin服务端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#zipkin服务端","aria-hidden":"true"}},[s._v("#")]),s._v(" zipkin服务端")]),s._v(" "),t("p",[s._v("zipkin服务端并非不能自己代码构建，但官方目前建议用已经提供好的server。构建方法也可以查看"),t("a",{attrs:{href:"https://zipkin.io/pages/quickstart.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("官网"),t("OutboundLink")],1),s._v("或者"),t("a",{attrs:{href:"https://github.com/openzipkin/zipkin#quick-start",target:"_blank",rel:"noopener noreferrer"}},[s._v("github"),t("OutboundLink")],1),s._v("，默认端口是9411，可通过几种方式构建。")]),s._v(" "),t("p",[s._v("Java环境，直接在终端执行")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("curl -sSL https://zipkin.io/quickstart.sh | bash -s\njava -jar zipkin.jar\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("如果实在Docker中，可直接使用")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("docker run -d -p 9411:9411 openzipkin/zipkin\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("最后一种方法，是直接拉取源代码编译，也很方便")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("# get the latest source\ngit clone https://github.com/openzipkin/zipkin\ncd zipkin\n# Build the server and also make its dependencies\n./mvnw -DskipTests --also-make -pl zipkin-server clean install\n# Run the server\njava -jar ./zipkin-server/target/zipkin-server-*exec.jar\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("完成后访问http://localhost:9411/ ，可查看到管理界面。")]),s._v(" "),t("p",[s._v("使用java -jar xxx.jar的方式启动，server所有参数都是默认的，如果要修改，比如集成了rabbitmq需要修改地址为localhost，那么启动命令就变成了")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("java -jar xxx.jar --zipkin.collector.rabbitmq.addresses=localhost\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("所有可以配置的参数都可以通过https://github.com/openzipkin/zipkin/blob/master/zipkin-server/src/main/resources/zipkin-server-shared.yml查看。")]),s._v(" "),t("h2",{attrs:{id:"zipkin客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#zipkin客户端","aria-hidden":"true"}},[s._v("#")]),s._v(" zipkin客户端")]),s._v(" "),t("p",[s._v("新建两个客户端client1和client2，然后通过client2调用client1中的某个服务。")]),s._v(" "),t("h2",{attrs:{id:"第一个客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第一个客户端","aria-hidden":"true"}},[s._v("#")]),s._v(" 第一个客户端")]),s._v(" "),t("p",[s._v("提供对外可访问的微服务，其中pom.xml相关依赖中需要引入spring-cloud-starter-zipkin。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-zipkin</artifactId>\n\t\t</dependency>\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("application.yml中，spring.zipkin.base-url指定server端的地址，spring.sleuth.sampler.probalility指定采样百分比，默认0.1，改成1.0表示所有数据都采用。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("server:\n  port: 9091\nspring:\n  application:\n    name: sleuth-zipkin-client1\n  zipkin: \n    base-url: http://localhost:9411/\n  sleuth:\n    sampler:\n      probability: 1.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("最后新建一个Controller，用来供第二个客户端调用")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class TestController {\n\n\t@GetMapping("/client1")\n\tpublic String test1() {\n\t\treturn "client1方法返回值";\n\t}\n\t\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("至此，第一个zipkin客户端创建完成。")]),s._v(" "),t("h2",{attrs:{id:"第二个客户端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第二个客户端","aria-hidden":"true"}},[s._v("#")]),s._v(" 第二个客户端")]),s._v(" "),t("p",[s._v("提供对外可访问的微服务，其中pom.xml相关依赖中需要引入spring-cloud-starter-zipkin。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-zipkin</artifactId>\n\t\t</dependency>\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("application.yml中，spring.zipkin.base-url指定server端的地址，spring.sleuth.sampler.probalility指定采样百分比，默认0.1，改成1.0表示所有数据都采用。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("server:\n  port: 9092\nspring:\n  application:\n    name: sleuth-zipkin-client2\n  zipkin:\n    base-url: http://localhost:9411\n  sleuth:\n    sampler:\n      probability: 1.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("p",[s._v("在启动类中添加一个Bean，用来注入RestTemplate。")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("@Bean\n    RestTemplate restTemplate() {\n        return new RestTemplate();\n    }\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("最后新建一个Controller，调用第一个客户端的服务")]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v('import org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.client.RestTemplate;\n\n@RestController\npublic class TestController {\n\n\t@Autowired private RestTemplate restTemplate;\n\t\n\t@GetMapping("/client2")\n\tpublic String test1() {\n\t\treturn restTemplate.getForObject("http://localhost:9091/client1", String.class);\n\t}\n\t\n}\n')])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("至此，第二个zipkin客户端创建完成。")]),s._v(" "),t("h2",{attrs:{id:"测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试","aria-hidden":"true"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),t("p",[s._v("调用http://localhost:9092/client2，可以调用多次，确认返回值是第一个客户端配置的数据。")]),s._v(" "),t("p",[s._v("然后查看http://localhost:9411，确认显示了刚刚调用的链路。")])])},[],!1,null,null,null);n.default=e.exports}}]);