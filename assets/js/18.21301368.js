(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{246:function(n,s,a){"use strict";a.r(s);var e=a(2),t=Object(e.a)({},function(){var n=this,s=n.$createElement,a=n._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[a("h2",{attrs:{id:"概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概念","aria-hidden":"true"}},[n._v("#")]),n._v(" 概念")]),n._v(" "),a("p",[n._v("在分布式系统中，由于服务数量巨多，为了方便服务配置文件统一管理，所以需要分布式配置中心组件。")]),n._v(" "),a("p",[n._v("本篇涉及项目的结构为一个Config Server用于链接Git仓库，一个Config Client通过server来展示配置文件数据。 同时使用两个bus来模拟配置文件刷新。")]),n._v(" "),a("h2",{attrs:{id:"文件准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#文件准备","aria-hidden":"true"}},[n._v("#")]),n._v(" 文件准备")]),n._v(" "),a("p",[n._v("在Git仓库中新建几个文件，分别放入相同参数的值。")]),n._v(" "),a("p",[n._v("四个文件")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("springcloud-7-config-dev.properties\nspringcloud-7-config-production.properties\nspringcloud-7-config-test.properties\nspringcloud-7-config.properties\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("p",[n._v("文件内容分别为")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("profile=dev\nprofile=production\nprofile=test\nprofile=config\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br")])]),a("h2",{attrs:{id:"config-server"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#config-server","aria-hidden":"true"}},[n._v("#")]),n._v(" Config Server")]),n._v(" "),a("p",[n._v("新建一个Config Server，分别配置pom.xml、application.yml，并在启动类中添加注释@EnableConfigServer。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-config-server</artifactId>\n\t\t</dependency>\nserver:\n  port: 9080\nspring:\n  application:\n    name: springcloud-config-server\n  cloud:\n    config:\n      server:\n        git:\n          uri: https://github.com/fymod/easy-spring-cloud\n          username:\n          password: \n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br")])]),a("p",[n._v("其中，spring.cloud.config.server.git.uri是存放文件对应的仓库地址，spring.cloud.config.server.git.username和spring.cloud.config.server.git.password分别对应git仓库的账号和密码。")]),n._v(" "),a("p",[n._v("以上步骤完成后，直接启动即可，然后浏览器地址栏输入http://localhost:9080/springcloud-7-config-dev.properties 查看数据，会显示对应的文件内容。浏览器输入 http://localhost:9080/springcloud-config-server/springcloud-7-config-dev 查看数据，会显示对应文件详细信息。")]),n._v(" "),a("p",[n._v("http请求地址：/{application}/{profile}[/{label}]\n资源文件：\n/{application}-{profile}.yml\n/{label}/{application}-{profile}.yml\n/{application}-{profile}.properties\n/{label}/{application}-{profile}.properties\n示例：本例中资源文件是config-dev.properties，其中config就是application，dev就是profile，匹配资源文件的第三种，访问地址就是/config(application)/dev(profile)")]),n._v(" "),a("h2",{attrs:{id:"config-client"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#config-client","aria-hidden":"true"}},[n._v("#")]),n._v(" Config Client")]),n._v(" "),a("p",[n._v("新建一个Config Client，分别配置pom.xml、application.yml、bootstrap.yml，并新建一个Controller用来展示获取到的数据。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-config</artifactId>\n\t\t</dependency>\nserver:\n  port: 9081\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br")])]),a("p",[n._v("bootstrap.yml中配置连接server的信息，不能卸载application.yml中。同时，spring.application.name必须和上传到git仓库中对应文件的application一致。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("spring:\n  application:\n    name: springcloud-7-config\n  cloud:\n    config:\n      uri: http://localhost:9080/\n      profile: dev\n      label: master\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br")])]),a("p",[n._v("最后新建一个Java类，实现数据的获取和展示。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('import org.springframework.beans.factory.annotation.Value;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\npublic class TestController {\n\n\t@Value("${profile}")\n\tprivate String profile;\n\t\n\t@GetMapping("/profile")\n\tpublic String getProfile() {\n\t\treturn this.profile;\n\t}\n\t\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br")])]),a("p",[n._v("以上步骤完成后，直接启动即可，然后浏览器地址栏输入http://localhost:9081/profile 查看数据，会显示dev配置文件中profile对应内容。")]),n._v(" "),a("h2",{attrs:{id:"bus"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#bus","aria-hidden":"true"}},[n._v("#")]),n._v(" BUS")]),n._v(" "),a("p",[n._v("以上demo的问题是，如果我修改了git仓库中文件的内容，项目并不会刷新。本节介绍如果应用刷新项目并通知到其他微服务。Config Server继续使用刚刚创建的。")]),n._v(" "),a("p",[n._v("在创建项目前，需要先安装RabbitMQ，安装步骤可点击"),a("a",{attrs:{href:"http://www.zhaoguojian.com/2018/06/18/%E5%9F%BA%E4%BA%8ESpringBoot%E5%92%8CRabbitMQ%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/",target:"_blank",rel:"noopener noreferrer"}},[n._v("这里"),a("OutboundLink")],1),n._v(" 查看。")]),n._v(" "),a("p",[n._v("新建两个Config Client，分别配置pom.xml、application.yml、bootstrap.yml，然后提供对外调用接口的Java类。除了端口号设置成不一致外，其他的完全一样。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-actuator</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.boot</groupId>\n\t\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-bus-amqp</artifactId>\n\t\t</dependency>\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-starter-config</artifactId>\n\t\t</dependency>\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br")])]),a("p",[n._v("application.yml中必须配置management.endpoints.web.exposure.include，否则不能调用刷新配置。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("server:\n  port: 9082\nmanagement:\n  endpoints:\n    web:\n      exposure:\n        include: bus-refresh\nspring:\n  application:\n    name: springcloud-7-config\n  cloud:\n    config:\n      uri: http://localhost:9080/\n      profile: dev\n      label: master\n  rabbitmq:\n    host: localhost\n    port: 5672\n    username: guest\n    password: guest\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br"),a("span",{staticClass:"line-number"},[n._v("19")]),a("br"),a("span",{staticClass:"line-number"},[n._v("20")]),a("br")])]),a("p",[n._v("Java类和其他常规不同的是需要增加注解@RefreshScope，这样在刷新之后才会将对应值改变。")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v('import org.springframework.beans.factory.annotation.Value;\nimport org.springframework.cloud.context.config.annotation.RefreshScope;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n@RestController\n@RefreshScope\npublic class TestController {\n\n\t@Value("${profile}")\n\tprivate String profile;\n\t\n\t@GetMapping("/profile")\n\tpublic String getProfile() {\n\t\treturn this.profile;\n\t}\n\t\n}\n')])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br"),a("span",{staticClass:"line-number"},[n._v("9")]),a("br"),a("span",{staticClass:"line-number"},[n._v("10")]),a("br"),a("span",{staticClass:"line-number"},[n._v("11")]),a("br"),a("span",{staticClass:"line-number"},[n._v("12")]),a("br"),a("span",{staticClass:"line-number"},[n._v("13")]),a("br"),a("span",{staticClass:"line-number"},[n._v("14")]),a("br"),a("span",{staticClass:"line-number"},[n._v("15")]),a("br"),a("span",{staticClass:"line-number"},[n._v("16")]),a("br"),a("span",{staticClass:"line-number"},[n._v("17")]),a("br"),a("span",{staticClass:"line-number"},[n._v("18")]),a("br")])]),a("p",[n._v("以上步骤完成后，分别启动server、bus1、bus2。")]),n._v(" "),a("ul",[a("li",[n._v("查看http://localhost:9082/profile 和 http://localhost:9083/profile ，显示的均为dev。")]),n._v(" "),a("li",[n._v("修改git仓库中dev对应的值为dev-change，然后继续访问两个地址，还是dev，证明尚未生效")]),n._v(" "),a("li",[n._v("POST方法调用地址http://localhost:9082/actuator/bus-refresh（项目启动的时候会有对应地址提示）")]),n._v(" "),a("li",[n._v("查看最开始两个地址，发现变成了dev-change")])]),n._v(" "),a("p",[n._v("POST方法可以使用PostMan或者在终端访问")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("curl -X POST http://localhost:9082/actuator/bus-refresh\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br")])]),a("h2",{attrs:{id:"结合eureka"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结合eureka","aria-hidden":"true"}},[n._v("#")]),n._v(" 结合Eureka")]),n._v(" "),a("p",[n._v("和常规的Eureka使用没有太大差别，唯一不同的就是client中bootstrap.yml对应配置")]),n._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[n._v("spring.application.name=config\nspring.cloud.config.label=master\nspring.cloud.config.profile=dev\n#spring.cloud.config.uri= http://localhost:9080/\nserver.port=9081\neureka.client.serviceUrl.defaultZone=http://localhost:9080/eureka/\nspring.cloud.config.discovery.enabled=true\nspring.cloud.config.discovery.serviceId=springcloud-config-server\n")])]),n._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[n._v("1")]),a("br"),a("span",{staticClass:"line-number"},[n._v("2")]),a("br"),a("span",{staticClass:"line-number"},[n._v("3")]),a("br"),a("span",{staticClass:"line-number"},[n._v("4")]),a("br"),a("span",{staticClass:"line-number"},[n._v("5")]),a("br"),a("span",{staticClass:"line-number"},[n._v("6")]),a("br"),a("span",{staticClass:"line-number"},[n._v("7")]),a("br"),a("span",{staticClass:"line-number"},[n._v("8")]),a("br")])]),a("p",[n._v("只需要删除spring.cloud.config.uri，并添加spring.cloud.config.discovery.enabled=true  和 spring.cloud.config.discovery.serviceId=微服务ConfigServer对应的ServerId")])])},[],!1,null,null,null);s.default=t.exports}}]);